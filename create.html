<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create a Memory - MemoryFrame</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0b0216;
      --bg-soft: #14021f;
      --accent: #9b6bff;
      --accent-2: #ff5fa3;
      --accent-soft: rgba(155, 107, 255, 0.12);
      --text: #f6f5ff;
      --muted: #aeb6d9;
      --danger: #ff4b81;
      --success: #22c55e;
      --radius-lg: 24px;
      --radius-md: 16px;
      --shadow-soft: 0 30px 80px rgba(7, 3, 20, 0.7);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top right, #2a113a 0, #0b0216 40%, #04000a 100%);
      color: var(--text);
      padding: 24px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.02), rgba(5, 6, 17, 0.9));
      border-radius: 32px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 255, 0.25);
      padding: 48px;
    }

    .header {
      margin-bottom: 32px;
      text-align: center;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      text-decoration: none;
      font-size: 13px;
      margin-bottom: 16px;
      transition: color 0.2s ease;
    }

    .back-link:hover {
      color: var(--text);
    }

    h1 {
      font-size: 32px;
      line-height: 1.2;
      letter-spacing: -0.04em;
      margin-bottom: 12px;
    }

    .subtitle {
      color: var(--muted);
      font-size: 15px;
    }

    .form-group {
      margin-bottom: 28px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .required {
      color: var(--danger);
    }

    input[type="text"],
    input[type="email"],
    textarea,
    select {
      width: 100%;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 255, 0.45);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      font-size: 14px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(127, 93, 255, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    .file-upload {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      min-height: 120px;
      border: 2px dashed rgba(148, 163, 255, 0.45);
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.6);
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .file-upload:hover {
      border-color: var(--accent);
      background: rgba(127, 93, 255, 0.1);
    }

    .file-upload input[type="file"] {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .file-upload-text {
      text-align: center;
      pointer-events: none;
    }

    .file-upload-icon {
      font-size: 32px;
    }

    .file-upload-label {
      font-size: 14px;
      color: var(--text);
      font-weight: 500;
    }

    .file-upload-hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .file-preview {
      margin-top: 12px;
      padding: 12px 16px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.5);
      border-radius: var(--radius-md);
      color: #bbf7d0;
      font-size: 13px;
      display: none;
    }

    .file-preview.visible {
      display: block;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .container {
        padding: 24px;
      }
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .checkbox-label {
      cursor: pointer;
      font-size: 13px;
      color: var(--muted);
    }

    .actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }

    .btn {
      flex: 1;
      padding: 12px 24px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #7f5dff, #ff4b81);
      color: white;
      box-shadow: 0 12px 30px rgba(127, 93, 255, 0.7);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 40px rgba(127, 93, 255, 0.9);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      border: 1px solid rgba(148, 163, 255, 0.4);
    }

    .btn-ghost:hover {
      background: rgba(30, 41, 79, 0.9);
      color: var(--text);
    }

    .progress {
      margin-bottom: 24px;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .progress-bar {
      height: 6px;
      background: rgba(148, 163, 255, 0.25);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #7f5dff, #ff4b81);
      width: 0%;
      transition: width 0.3s ease;
    }

    .help-text {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .success-message {
      display: none;
      padding: 16px;
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.5);
      border-radius: var(--radius-md);
      color: #bbf7d0;
      margin-bottom: 24px;
      font-size: 14px;
    }

    .success-message.visible {
      display: block;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <a class="site-logo" href="Index.html">MemoryFrame</a>
    <nav class="site-nav" aria-label="Primary">
      <a href="Index.html">Home</a>
      <a href="memory.html">Open</a>
    </nav>
  </header>
  <div class="container">
    <div class="header">
      <a href="Index.html" class="back-link">‚Üê Back to home</a>
      <h1>Create a Memory</h1>
      <p class="subtitle">Turn a video into a shareable, scannable memory</p>
    </div>

    <form id="memoryForm">
      <div class="success-message" id="successMessage">
        ‚úì Memory created successfully! Share the link or print the QR code.
      </div>

      <!-- Print options (hidden until memory created) -->
      <div id="printOptions" style="display:none;margin-top:16px;">
        <h3 style="margin-bottom:8px;color:var(--text);">Print & Order</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center;">
          <label style="font-size:13px;color:var(--muted);">Size</label>
          <select id="printSize">
            <option value="4x6" data-price="0.39">4 √ó 6</option>
            <option value="5x7" data-price="0.59">5 √ó 7</option>
            <option value="8x10" data-price="1.29">8 √ó 10</option>
            <option value="11x14" data-price="3.99">11 √ó 14</option>
          </select>

          <label style="font-size:13px;color:var(--muted);">Finish</label>
          <select id="printFinish">
            <option value="glossy" data-mult="1">Glossy</option>
            <option value="matte" data-mult="1.1">Matte (+10%)</option>
            <option value="lustre" data-mult="1.25">Lustre (+25%)</option>
          </select>

          <label style="font-size:13px;color:var(--muted);">Quantity</label>
          <input id="printQty" type="number" min="1" value="1" />

          <label style="font-size:13px;color:var(--muted);">Frame</label>
          <select id="printFrame">
            <option value="none" data-add="0">None</option>
            <option value="simple" data-add="4.99">Simple (+$4.99)</option>
            <option value="premium" data-add="12.99">Premium (+$12.99)</option>
          </select>
        </div>

        <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:12px;">
          <div style="color:var(--muted);">Estimated price: <strong id="printPrice">$0.00</strong></div>
          <div style="display:flex;gap:8px;">
            <button id="previewPrintBtn" type="button" class="btn btn-ghost">Preview</button>
            <button id="orderShutterBtn" type="button" class="btn btn-primary">Order via Shutterfly</button>
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress">
        <div class="progress-label">
          <span>Creating your memory...</span>
          <span id="progressText">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>

      <!-- Memory Title -->
      <div class="form-group">
        <label for="title">Memory Title <span class="required">*</span></label>
        <input type="text" id="title" name="title" placeholder="e.g., Sarah's 30th Birthday Party" required />
        <div class="help-text">Give your memory a meaningful name</div>
      </div>

      <!-- Description -->
      <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description" placeholder="Tell the story behind this memory..."></textarea>
        <div class="help-text">Optional: Add context or details about this memory</div>
      </div>

      <!-- Video Upload -->
      <div class="form-group">
        <label>Video File <span class="required">*</span></label>
        <div class="file-upload">
          <div class="file-upload-text">
            <div class="file-upload-icon">üé¨</div>
            <div class="file-upload-label">Click to upload or drag and drop</div>
            <div class="file-upload-hint">MP4, WebM, MOV up to 2GB</div>
          </div>
          <!-- make file upload reveal on scroll -->
          <div class="reveal" style="height:0;width:0;overflow:hidden;visibility:hidden"></div>
          <input type="file" id="videoFile" name="videoFile" accept="video/*" required />
        </div>
        <div class="file-preview" id="filePreview"></div>
      </div>

      <!-- Date & Category -->
      <div class="form-row">
        <div class="form-group">
          <label for="date">Date of Memory</label>
          <input type="text" id="date" name="date" placeholder="e.g., December 16, 2025" />
          <div class="help-text">When did this moment happen?</div>
        </div>

        <div class="form-group">
          <label for="category">Category</label>
          <select id="category" name="category">
            <option value="">Select a category</option>
            <option value="birthday">Birthday</option>
            <option value="wedding">Wedding</option>
            <option value="anniversary">Anniversary</option>
            <option value="graduation">Graduation</option>
            <option value="vacation">Vacation</option>
            <option value="family">Family Moment</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>

      <!-- Visibility -->
      <div class="form-group">
        <label>Who can watch this?</label>
        <div style="margin-top: 12px;">
          <div class="checkbox-group">
            <input type="radio" id="public" name="visibility" value="public" checked />
            <label for="public" class="checkbox-label">Anyone with the link</label>
          </div>
          <div class="help-text">Anyone who has the link or scans the QR code can watch</div>
        </div>
        <div style="margin-top: 16px;">
          <div class="checkbox-group">
            <input type="radio" id="password" name="visibility" value="password" />
            <label for="password" class="checkbox-label">Password protected</label>
          </div>
          <div class="help-text">Viewers need a password to watch (coming soon)</div>
        </div>
      </div>

      <!-- Password Field (hidden by default) -->
      <div class="form-group" id="passwordGroup" style="display: none;">
        <label for="password">Password</label>
        <input type="text" id="password" name="password" placeholder="Create a password for viewers" />
      </div>

      <!-- Terms -->
      <div class="form-group">
        <div class="checkbox-group">
          <input type="checkbox" id="terms" name="terms" required />
          <label for="terms" class="checkbox-label">I agree to the Terms of Service and acknowledge my responsibility for the content</label>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button type="button" class="btn btn-ghost" onclick="window.location.href='index.html'">Cancel</button>
        <button type="submit" class="btn btn-primary">Create Memory</button>
      </div>
    </form>
  </div>

  <!-- Supabase client (UMD) and config -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.26.0/dist/umd/supabase.min.js"></script>
  <script src="/supabase-config.js"></script>

  <script>
    // small reveal classes applied by animations.js
    // Initialize Supabase (injected below via CDN + config)
    let supabaseClient = null;

    function ensureSupabase() {
      if (!supabaseClient && typeof supabase !== 'undefined' && typeof SUPABASE_URL !== 'undefined') {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    }

    const form = document.getElementById('memoryForm');
    const videoInput = document.getElementById('videoFile');
    const filePreview = document.getElementById('filePreview');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const passwordGroup = document.getElementById('passwordGroup');
    const visibilityOptions = document.querySelectorAll('input[name="visibility"]');
    const successMessage = document.getElementById('successMessage');

    // File upload preview
    videoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const size = (file.size / 1024 / 1024).toFixed(2);
        filePreview.textContent = `‚úì ${file.name} (${size} MB)`;
        filePreview.classList.add('visible');
      }
    });

    // Handle visibility change
    visibilityOptions.forEach(option => {
      option.addEventListener('change', (e) => {
        if (e.target.value === 'password') {
          passwordGroup.style.display = 'block';
        } else {
          passwordGroup.style.display = 'none';
        }
      });
    });

    // Form submission ‚Äî uploads file to Supabase Storage and creates a DB record
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      ensureSupabase();

      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const category = document.getElementById('category').value;
      const date = document.getElementById('date').value;
      const visibility = document.querySelector('input[name="visibility"]:checked').value;
      const password = document.getElementById('password')?.value || null;
      const file = videoInput.files[0];

      if (!file) {
        alert('Please select a video file.');
        return;
      }

      if (!supabaseClient) {
        // If Supabase not available, fallback to demo behaviour
        alert('Supabase client not initialized ‚Äî using demo flow.');
        // maintain previous demo behavior
        progressFill.style.width = '100%';
        progressText.textContent = '100%';
        successMessage.classList.add('visible');
        setTimeout(() => successMessage.classList.remove('visible'), 5000);
        form.reset();
        filePreview.classList.remove('visible');
        return;
      }

      // show initial progress
      progressFill.style.width = '6%';
      progressText.textContent = '6%';

      try {
        // create a unique path
        const filePath = `memories/${Date.now()}_${file.name}`;

        // upload to Supabase Storage (bucket: memories)
        const { data: uploadData, error: uploadError } = await supabaseClient.storage
          .from('memories')
          .upload(filePath, file, { cacheControl: '3600', upsert: false });

        if (uploadError) throw uploadError;

        progressFill.style.width = '60%';
        progressText.textContent = '60%';

        // get public URL
        const { data: publicData } = supabaseClient.storage.from('memories').getPublicUrl(filePath);
        const publicUrl = publicData?.publicUrl || null;

        // insert record in 'memories' table
        // Insert minimal fields into the existing `memories` table (title, video_url)
        const payload = {
          title: title || file.name,
          video_url: publicUrl,
        };

        const { data: insertData, error: insertError } = await supabaseClient.from('memories').insert([payload]).select();
        if (insertError) throw insertError;

        progressFill.style.width = '100%';
        progressText.textContent = '100%';

        successMessage.classList.add('visible');
        form.reset();
        filePreview.classList.remove('visible');

        // show link to memory
        const created = Array.isArray(insertData) ? insertData[0] : insertData;
        if (created && created.id) {
          const link = `${location.origin}${location.pathname.replace(/create\.html$/, '')}memory.html?id=${created.id}`;
          const showLink = document.createElement('div');
          showLink.style.marginTop = '12px';
          showLink.style.color = 'var(--muted)';
          showLink.innerHTML = `Memory created ‚Äî <a href="${link}" style="color:var(--accent);">Open memory</a>`;
          successMessage.appendChild(showLink);

          // show print options and attach the memory link for preview/order
          const printOptions = document.getElementById('printOptions');
          printOptions.style.display = 'block';
          printOptions.dataset.memoryLink = link;
          updatePrintPrice();
        }

        // Hide success after 8 seconds
        setTimeout(() => {
          successMessage.classList.remove('visible');
          if (successMessage.lastChild && successMessage.lastChild.tagName === 'DIV') successMessage.removeChild(successMessage.lastChild);
        }, 8000);

      } catch (err) {
        console.error('Upload error', err);
        alert('Error creating memory: ' + (err.message || JSON.stringify(err)));
      }
    });

    // Print options logic
    function currency(n){return '$'+(n.toFixed(2));}
    function updatePrintPrice(){
      const sizeSelect = document.getElementById('printSize');
      const finishSelect = document.getElementById('printFinish');
      const qty = parseInt(document.getElementById('printQty').value||1,10);
      const frame = parseFloat(document.getElementById('printFrame').selectedOptions[0].dataset.add||0);
      const base = parseFloat(sizeSelect.selectedOptions[0].dataset.price||0.5);
      const mult = parseFloat(finishSelect.selectedOptions[0].dataset.mult||1);
      const price = ((base * mult) * qty) + frame;
      document.getElementById('printPrice').textContent = currency(price);
      return price;
    }

    document.getElementById('printSize').addEventListener('change', updatePrintPrice);
    document.getElementById('printFinish').addEventListener('change', updatePrintPrice);
    document.getElementById('printQty').addEventListener('input', updatePrintPrice);
    document.getElementById('printFrame').addEventListener('change', updatePrintPrice);

    document.getElementById('previewPrintBtn').addEventListener('click', ()=>{
      const container = document.getElementById('printOptions');
      const link = container.dataset.memoryLink || location.href;
      const title = document.getElementById('title').value || 'Memory Print';
      const desc = document.getElementById('description').value || '';
      const price = document.getElementById('printPrice').textContent;

      const w = window.open('', '_blank');
      const html = `<!doctype html><html><head><meta charset="utf-8"><title>Print Preview</title>
        <style>body{font-family:system-ui,Arial;background:#050018;color:#fff;padding:24px} .card{background:#0b0216;border-radius:12px;padding:20px}</style></head><body>
        <div class="card">
        <h2>${title}</h2>
        <p style="color:#bfc6e8">${desc}</p>
        <p>Link: <a href="${link}" target="_blank">${link}</a></p>
        <p>Estimated price: <strong>${price}</strong></p>
        </div>
        <script>window.print();</script>
        </body></html>`;
      w.document.write(html);
      w.document.close();
    });

    // Order via Shutterfly opens provided Shutterfly prints page in a new tab
    document.getElementById('orderShutterBtn').addEventListener('click', ()=>{
      // Provided Shutterfly URL
      const shutterUrl = 'https://www.shutterfly.com/prints/?CID=SEMSN.PRINTS.21700000001930203_71700000092421536_138088976074&gclid=49f92a702eb315f8f38a4332abbbf5f7&gclsrc=3p.ds&msclkid=49f92a702eb315f8f38a4332abbbf5f7';
      window.open(shutterUrl, '_blank');
    });
  </script>
  <script src="/animations.js"></script>
</body>
</html>
